<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Replication | LinDB</title>
    <meta name="description" content="A distributed time series database">
    <meta name="keywords" content="lindb tsdb">
  <link rel="shortcut icon" href="/images/logo.png">
  <link rel="stylesheet" type="text/css" href="//at.alicdn.com/t/font_1331329_he22yc3ekc6.css">
    
    <link rel="preload" href="/assets/css/0.styles.0b112324.css" as="style"><link rel="preload" href="/assets/js/app.056f55ab.js" as="script"><link rel="preload" href="/assets/js/2.0bd9a96c.js" as="script"><link rel="preload" href="/assets/js/13.7ebf3603.js" as="script"><link rel="prefetch" href="/assets/js/10.8b3f75a1.js"><link rel="prefetch" href="/assets/js/11.af04e2ec.js"><link rel="prefetch" href="/assets/js/12.8f4ab7f9.js"><link rel="prefetch" href="/assets/js/14.0a998c17.js"><link rel="prefetch" href="/assets/js/15.b4009e89.js"><link rel="prefetch" href="/assets/js/16.4bbc1e9c.js"><link rel="prefetch" href="/assets/js/17.ca020fbf.js"><link rel="prefetch" href="/assets/js/18.915c14ca.js"><link rel="prefetch" href="/assets/js/19.2b602f72.js"><link rel="prefetch" href="/assets/js/20.4cfd140d.js"><link rel="prefetch" href="/assets/js/21.3367b9a8.js"><link rel="prefetch" href="/assets/js/22.29b13673.js"><link rel="prefetch" href="/assets/js/23.e8112de3.js"><link rel="prefetch" href="/assets/js/24.fcb08cdb.js"><link rel="prefetch" href="/assets/js/25.45f19a57.js"><link rel="prefetch" href="/assets/js/26.4b5652e0.js"><link rel="prefetch" href="/assets/js/27.04c38622.js"><link rel="prefetch" href="/assets/js/28.cc8d0385.js"><link rel="prefetch" href="/assets/js/29.03302385.js"><link rel="prefetch" href="/assets/js/3.2fd9c01f.js"><link rel="prefetch" href="/assets/js/30.529ed3a1.js"><link rel="prefetch" href="/assets/js/31.1a5e4f14.js"><link rel="prefetch" href="/assets/js/32.0850880c.js"><link rel="prefetch" href="/assets/js/33.041c6874.js"><link rel="prefetch" href="/assets/js/34.ce5ccbaf.js"><link rel="prefetch" href="/assets/js/35.623a9869.js"><link rel="prefetch" href="/assets/js/36.c3c66f85.js"><link rel="prefetch" href="/assets/js/37.a399b00c.js"><link rel="prefetch" href="/assets/js/38.29e487a8.js"><link rel="prefetch" href="/assets/js/39.2b41a002.js"><link rel="prefetch" href="/assets/js/4.82d2da6a.js"><link rel="prefetch" href="/assets/js/40.397db20c.js"><link rel="prefetch" href="/assets/js/41.5c025ca3.js"><link rel="prefetch" href="/assets/js/42.b12ace93.js"><link rel="prefetch" href="/assets/js/5.8d90e3d9.js"><link rel="prefetch" href="/assets/js/6.2b795c03.js"><link rel="prefetch" href="/assets/js/7.ee020972.js"><link rel="prefetch" href="/assets/js/8.30ee74ad.js"><link rel="prefetch" href="/assets/js/9.3f433fb3.js">
    <link rel="stylesheet" href="/assets/css/0.styles.0b112324.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/images/logo.png" alt="LinDB" class="logo"> <span class="site-name can-hide">LinDB</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/docs/introduction/overview.html" class="nav-link">Docs</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Select language" class="dropdown-title"><span class="title">Languages</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/docs/design/replication.html" class="nav-link router-link-exact-active router-link-active">English</a></li><li class="dropdown-item"><!----> <a href="/zh/docs/design/replication.html" class="nav-link">简体中文</a></li></ul></div></div> <a href="https://github.com/lindb/lindb" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/docs/introduction/overview.html" class="nav-link">Docs</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Select language" class="dropdown-title"><span class="title">Languages</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/docs/design/replication.html" class="nav-link router-link-exact-active router-link-active">English</a></li><li class="dropdown-item"><!----> <a href="/zh/docs/design/replication.html" class="nav-link">简体中文</a></li></ul></div></div> <a href="https://github.com/lindb/lindb" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Concept</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/docs/introduction/overview.html" class="sidebar-link">Overview</a></li><li><a href="/docs/introduction/project-layout.html" class="sidebar-link">Project Layout</a></li><li><a href="/docs/introduction/installation.html" class="sidebar-link">Installation</a></li><li><a href="/docs/introduction/comparision.html" class="sidebar-link">Comparision to Other TSDB</a></li><li><a href="/docs/introduction/roadmap.html" class="sidebar-link">RoadMap</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>User Guide</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/docs/concept/datamodel.html" class="sidebar-link">Data Model</a></li><li><a href="/docs/concept/dtomodel.html" class="sidebar-link">DTO Model</a></li><li><a href="/docs/concept/fieldtype.html" class="sidebar-link">Field Type</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Design</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/docs/design/architecture.html" class="sidebar-link">Architecture</a></li><li><a href="/docs/design/coordinator.html" class="sidebar-link">Coordinator</a></li><li><a href="/docs/design/replication.html" class="active sidebar-link">Replication</a></li><li><a href="/docs/design/query.html" class="sidebar-link">Query</a></li><li><a href="/docs/design/memory.html" class="sidebar-link">Memory</a></li><li><a href="/docs/design/index_.html" class="sidebar-link">Index</a></li><li><a href="/docs/design/storage.html" class="sidebar-link">Storage</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="replication"><a href="#replication" class="header-anchor">#</a> Replication</h1> <p>The client sends the time series data (including database, metric name, tags, timestamp, fields information) to the broker through the tcp or http protocol. The broker first determines whether the database exists. If exist, calculate the shard number according to the total number of shards configured, metric name, tags, and database, then write the data to the corresponding memory buffer of the shard. When the buffer size exceeds the limit or the write time exceeds the limit, the data in the memory buffer is appended as a record to the disk log file to which the current shard belongs.</p> <p>A shard according to the configured number of replicas will correspond to one or more physical storage nodes. The broker queries the data in etcd to learn the information, and replicates the records in the shard log file to the corresponding storage node through rpc. According to the current design, the storage directly writes the record data into the memory, and no additional wal is needed. After the in-memory data is written to the disk, the storage informs the broker that this part of the data has been completely consumed through rpc. After all the storage nodes inform the broker consuming records successfully, the broker can delete the disk log file.</p> <p>The replication process of a shard can be abstracted into the production and consumption process of the Fanout queue. The implementation is inspired by <a href="https://github.com/bulldog2011/bigqueue" target="_blank" rel="noopener noreferrer">bigqueue<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>. The broker calculates the shard number of time series data, batches in-memory for efficiency, then write to the Fanout queue, the asynchronous go routine is responsible for pushing the data to the corresponding storage node.</p> <p><img src="/assets/img/replication.5e465ab4.png" alt="replication"></p> <p>The time series database does not require the sequential writing. As long as the data is finally written, the result of the query is consistent. The sequence is maintained when replicating records from broker to storage in order to ensure accurate data replication under various abnormal scenarios.</p> <p>Broker replication procedures:</p> <ol><li><p>The broker consults the index of the storage consumption record. If the index is valid (neighter exceeding the head index currently written by the broker, nor less than the tail index that the broker has already acked), go to step 3, otherwise go to step 2.</p></li> <li><p>Reset the index of the storage with the index recorded by the broker, and proceed to step 3.</p></li> <li><p>Replicate records from the index to the storage, if there is an exception, go back to step 1.</p></li></ol> <p>Storage replicaiton procedures:</p> <ol><li><p>Respond to the broker query, reset index request</p></li> <li><p>Receive the record of the push copy of the broker, check whether the index of the record and the index of the storage record are consistent. If yes, return ok, index increments by 1, otherwise it returns an error.</p></li></ol></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/lindb/lindb.github.io/edit/dev/docs/docs/design/replication.md" target="_blank" rel="noopener noreferrer">Edit this page on GitHub</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">5/16/2022, 3:08:58 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/docs/design/coordinator.html" class="prev">Coordinator</a></span> <span class="next"><a href="/docs/design/query.html">Query</a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.056f55ab.js" defer></script><script src="/assets/js/2.0bd9a96c.js" defer></script><script src="/assets/js/13.7ebf3603.js" defer></script>
  </body>
</html>
