<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.45">
    <style>
      :root {
        --c-bg: #fff;
      }
      html.dark {
        --c-bg: #22272e;
      }
      html, body {
        background-color: var(--c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme');
			const systemDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
			if (userMode === 'dark' || (userMode !== 'light' && systemDarkMode)) {
				document.documentElement.classList.toggle('dark', true);
			}
    </script>
    <link rel="icon" href="/images/logo.png"><link rel="stylesheet" type="text/css" href="//at.alicdn.com/t/font_1331329_he22yc3ekc6.css"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Coordinator | LinDB</title><meta name="description" content="A distributed time series database">
    <link rel="modulepreload" href="/assets/app.1245c310.js"><link rel="modulepreload" href="/assets/coordinator.html.913f65ca.js"><link rel="modulepreload" href="/assets/coordinator.html.e33865cf.js"><link rel="prefetch" href="/assets/index.html.b7727a54.js"><link rel="prefetch" href="/assets/project-layout.html.a4629c0e.js"><link rel="prefetch" href="/assets/architecture.html.103f1cb2.js"><link rel="prefetch" href="/assets/index_.html.79572b7d.js"><link rel="prefetch" href="/assets/memory.html.3307ef46.js"><link rel="prefetch" href="/assets/query.html.83857a74.js"><link rel="prefetch" href="/assets/replication.html.d8debbb6.js"><link rel="prefetch" href="/assets/storage.html.9d3cf863.js"><link rel="prefetch" href="/assets/admin-ui.html.7e59a287.js"><link rel="prefetch" href="/assets/api.html.973e558b.js"><link rel="prefetch" href="/assets/configuration.html.3111e0ba.js"><link rel="prefetch" href="/assets/installation.html.fdc905d0.js"><link rel="prefetch" href="/assets/overview.html.9a55cdf6.js"><link rel="prefetch" href="/assets/sql.html.8680f7c7.js"><link rel="prefetch" href="/assets/index.html.75e6b82c.js"><link rel="prefetch" href="/assets/datamodel.html.52b5cccd.js"><link rel="prefetch" href="/assets/dtomodel.html.7a4e905b.js"><link rel="prefetch" href="/assets/fieldtype.html.8b470ff4.js"><link rel="prefetch" href="/assets/comparision.html.2a5b8334.js"><link rel="prefetch" href="/assets/roadmap.html.10a03183.js"><link rel="prefetch" href="/assets/project-layout.html.238330e8.js"><link rel="prefetch" href="/assets/architecture.html.9d76a560.js"><link rel="prefetch" href="/assets/coordinator.html.6c762904.js"><link rel="prefetch" href="/assets/index_.html.0ba0078f.js"><link rel="prefetch" href="/assets/memory.html.3ea92e81.js"><link rel="prefetch" href="/assets/query.html.a40c8f20.js"><link rel="prefetch" href="/assets/replication.html.27d90e28.js"><link rel="prefetch" href="/assets/storage.html.32615d67.js"><link rel="prefetch" href="/assets/index.html.a4e417bb.js"><link rel="prefetch" href="/assets/admin-ui.html.7d72bb8a.js"><link rel="prefetch" href="/assets/api.html.06310af3.js"><link rel="prefetch" href="/assets/cli.html.43e41297.js"><link rel="prefetch" href="/assets/configuration.html.6c713c1e.js"><link rel="prefetch" href="/assets/glossary.html.4ecb27d8.js"><link rel="prefetch" href="/assets/installation.html.a5b7efe2.js"><link rel="prefetch" href="/assets/lql.html.42f1764d.js"><link rel="prefetch" href="/assets/overview.html.0f16248f.js"><link rel="prefetch" href="/assets/datamodel.html.56c2a7a8.js"><link rel="prefetch" href="/assets/dtomodel.html.4d240700.js"><link rel="prefetch" href="/assets/fieldtype.html.7b533eb5.js"><link rel="prefetch" href="/assets/comparision.html.3e14341b.js"><link rel="prefetch" href="/assets/roadmap.html.33cbcfc5.js"><link rel="prefetch" href="/assets/index.html.7bcd1f19.js"><link rel="prefetch" href="/assets/explore.html.3ef2d05c.js"><link rel="prefetch" href="/assets/metadata.html.1bb86786.js"><link rel="prefetch" href="/assets/monitoring.html.bcb64307.js"><link rel="prefetch" href="/assets/overview.html.4b875951.js"><link rel="prefetch" href="/assets/search.html.7d7e41d0.js"><link rel="prefetch" href="/assets/404.html.f166316b.js"><link rel="prefetch" href="/assets/index.html.953850bf.js"><link rel="prefetch" href="/assets/project-layout.html.5f948252.js"><link rel="prefetch" href="/assets/architecture.html.29886a84.js"><link rel="prefetch" href="/assets/index_.html.ea40a59c.js"><link rel="prefetch" href="/assets/memory.html.ce24a23b.js"><link rel="prefetch" href="/assets/query.html.fb1f5ea1.js"><link rel="prefetch" href="/assets/replication.html.37b73804.js"><link rel="prefetch" href="/assets/storage.html.a70208fd.js"><link rel="prefetch" href="/assets/admin-ui.html.2ed083ff.js"><link rel="prefetch" href="/assets/api.html.d89b9dfb.js"><link rel="prefetch" href="/assets/configuration.html.bf66527b.js"><link rel="prefetch" href="/assets/installation.html.c10a6549.js"><link rel="prefetch" href="/assets/overview.html.0348273a.js"><link rel="prefetch" href="/assets/sql.html.27baae5e.js"><link rel="prefetch" href="/assets/index.html.e72dc124.js"><link rel="prefetch" href="/assets/datamodel.html.c025c119.js"><link rel="prefetch" href="/assets/dtomodel.html.f4fc5e15.js"><link rel="prefetch" href="/assets/fieldtype.html.97cd5b90.js"><link rel="prefetch" href="/assets/comparision.html.411af8eb.js"><link rel="prefetch" href="/assets/roadmap.html.a3cb2bb6.js"><link rel="prefetch" href="/assets/project-layout.html.f94f32bd.js"><link rel="prefetch" href="/assets/architecture.html.80414f89.js"><link rel="prefetch" href="/assets/coordinator.html.8ec46303.js"><link rel="prefetch" href="/assets/index_.html.43b6e4ad.js"><link rel="prefetch" href="/assets/memory.html.a79e7fc0.js"><link rel="prefetch" href="/assets/query.html.877c67b5.js"><link rel="prefetch" href="/assets/replication.html.2ae34cc1.js"><link rel="prefetch" href="/assets/storage.html.ebb9bbff.js"><link rel="prefetch" href="/assets/index.html.805a8131.js"><link rel="prefetch" href="/assets/admin-ui.html.89067a62.js"><link rel="prefetch" href="/assets/api.html.3dfd1506.js"><link rel="prefetch" href="/assets/cli.html.95331d53.js"><link rel="prefetch" href="/assets/configuration.html.34943d8c.js"><link rel="prefetch" href="/assets/glossary.html.0507f024.js"><link rel="prefetch" href="/assets/installation.html.770a8b95.js"><link rel="prefetch" href="/assets/lql.html.be4f3a62.js"><link rel="prefetch" href="/assets/overview.html.4df29ceb.js"><link rel="prefetch" href="/assets/datamodel.html.5266ce24.js"><link rel="prefetch" href="/assets/dtomodel.html.f4be2ad4.js"><link rel="prefetch" href="/assets/fieldtype.html.5f24c4f4.js"><link rel="prefetch" href="/assets/comparision.html.1b1d6fa7.js"><link rel="prefetch" href="/assets/roadmap.html.3b37b0e4.js"><link rel="prefetch" href="/assets/index.html.879f33c3.js"><link rel="prefetch" href="/assets/explore.html.cf540522.js"><link rel="prefetch" href="/assets/metadata.html.d565de8f.js"><link rel="prefetch" href="/assets/monitoring.html.95a08391.js"><link rel="prefetch" href="/assets/overview.html.b70b858c.js"><link rel="prefetch" href="/assets/search.html.62be0060.js"><link rel="prefetch" href="/assets/404.html.6fe00063.js"><link rel="prefetch" href="/assets/404.d585f2dc.js"><link rel="prefetch" href="/assets/Layout.479720ed.js"><link rel="prefetch" href="/assets/HomeBackgroundCanvas.7152b788.js"><link rel="prefetch" href="/assets/HomePage.0486f96b.js"><link rel="prefetch" href="/assets/ImageWindow.43b43422.js"><link rel="prefetch" href="/assets/IntroItem.f7b52abc.js"><link rel="prefetch" href="/assets/IntroList.5be15e35.js"><link rel="prefetch" href="/assets/LinFooter.4ab9a6cd.js"><link rel="prefetch" href="/assets/Page.c15baf89.js"><link rel="prefetch" href="/assets/Scrollbar.75566d90.js"><link rel="prefetch" href="/assets/Sidebar.b58d2f9d.js"><link rel="prefetch" href="/assets/Toc.a71f3d4e.js">
    <link rel="stylesheet" href="/assets/style.51733ec4.css">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><div class="theme-container"><!--[--><header class="navbar"><div class="toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a href="/" class=""><!----><span class="site-name can-hide">LinDB</span></a></span><div class="navbar-items-wrapper" style=""><!--[--><!--]--><nav class="navbar-items can-hide"><!--[--><div class="navbar-item"><a href="/guide/overview" class="" aria-label="Guide"><!--[--><!--]--> Guide <!--[--><!--]--></a></div><div class="navbar-item"><a href="/design/architecture" class="" aria-label="Design"><!--[--><!--]--> Design <!--[--><!--]--></a></div><div class="navbar-item"><a href="/community/project-layout" class="" aria-label="Community"><!--[--><!--]--> Community <!--[--><!--]--></a></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="Select language"><span class="title">Languages</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="Select language"><span class="title">Languages</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a aria-current="page" href="/design/coordinator.html" class="router-link-active router-link-exact-active router-link-active" aria-label="English"><!--[--><!--]--> English <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/zh/design/coordinator.html" class="" aria-label="简体中文"><!--[--><!--]--> 简体中文 <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-item"><a class="external-link" href="https://github.com/lindb/lindb" rel="noopener noreferrer" target="_blank" aria-label="GitHub"><!--[--><!--]--> GitHub <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button class="toggle-dark-button" title="toggle dark mode"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><form class="search-box" role="search"><input type="search" autocomplete="off" spellcheck="false" value><!----></form></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><div class="scrollbar"><div class="scrollbar-container"><!--[--><div class="scrollbar-content" style=""><!--[--><nav class="navbar-items"><!--[--><div class="navbar-item"><a href="/guide/overview" class="" aria-label="Guide"><!--[--><!--]--> Guide <!--[--><!--]--></a></div><div class="navbar-item"><a href="/design/architecture" class="" aria-label="Design"><!--[--><!--]--> Design <!--[--><!--]--></a></div><div class="navbar-item"><a href="/community/project-layout" class="" aria-label="Community"><!--[--><!--]--> Community <!--[--><!--]--></a></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="Select language"><span class="title">Languages</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="Select language"><span class="title">Languages</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a aria-current="page" href="/design/coordinator.html" class="router-link-active router-link-exact-active router-link-active" aria-label="English"><!--[--><!--]--> English <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/zh/design/coordinator.html" class="" aria-label="简体中文"><!--[--><!--]--> 简体中文 <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-item"><a class="external-link" href="https://github.com/lindb/lindb" rel="noopener noreferrer" target="_blank" aria-label="GitHub"><!--[--><!--]--> GitHub <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><!--]--></nav><ul class="sidebar-items"><!--[--><li><p tabindex="0" class="sidebar-item sidebar-heading active">Design <!----></p><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a href="/design/architecture.html" class="sidebar-item" aria-label="Architecture"><!--[--><!--]--> Architecture <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/design/coordinator.html" class="router-link-active router-link-exact-active router-link-active sidebar-item active" aria-label="Coordinator"><!--[--><!--]--> Coordinator <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/design/coordinator.html#overview" class="router-link-active router-link-exact-active sidebar-item" aria-label="Overview"><!--[--><!--]--> Overview <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/design/coordinator.html#master" class="router-link-active router-link-exact-active sidebar-item" aria-label="Master"><!--[--><!--]--> Master <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/design/coordinator.html#task" class="router-link-active router-link-exact-active sidebar-item" aria-label="Task"><!--[--><!--]--> Task <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/design/coordinator.html#controller" class="router-link-active router-link-exact-active sidebar-item" aria-label="Controller:"><!--[--><!--]--> Controller: <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/design/coordinator.html#executor" class="router-link-active router-link-exact-active sidebar-item" aria-label="Executor"><!--[--><!--]--> Executor <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a aria-current="page" href="/design/coordinator.html#state-machine" class="router-link-active router-link-exact-active sidebar-item" aria-label="State Machine"><!--[--><!--]--> State Machine <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/design/coordinator.html#broker-node-state-machine" class="router-link-active router-link-exact-active sidebar-item" aria-label="Broker Node State Machine"><!--[--><!--]--> Broker Node State Machine <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/design/coordinator.html#storage-cluster-status-state-machine" class="router-link-active router-link-exact-active sidebar-item" aria-label="Storage Cluster Status State Machine"><!--[--><!--]--> Storage Cluster Status State Machine <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/design/coordinator.html#db-admin-state-machine" class="router-link-active router-link-exact-active sidebar-item" aria-label="DB Admin State Machine"><!--[--><!--]--> DB Admin State Machine <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/design/coordinator.html#storage-cluster-state-machine" class="router-link-active router-link-exact-active sidebar-item" aria-label="Storage Cluster State Machine"><!--[--><!--]--> Storage Cluster State Machine <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/design/coordinator.html#replicator-state-machine" class="router-link-active router-link-exact-active sidebar-item" aria-label="Replicator State Machine"><!--[--><!--]--> Replicator State Machine <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/design/coordinator.html#replica-status-state-machine" class="router-link-active router-link-exact-active sidebar-item" aria-label="Replica Status State Machine"><!--[--><!--]--> Replica Status State Machine <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a aria-current="page" href="/design/coordinator.html#fault-tolerance" class="router-link-active router-link-exact-active sidebar-item" aria-label="Fault tolerance"><!--[--><!--]--> Fault tolerance <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a href="/design/query.html" class="sidebar-item" aria-label="Query"><!--[--><!--]--> Query <!--[--><!--]--></a><!----></li><li><a href="/design/replication.html" class="sidebar-item" aria-label="copy"><!--[--><!--]--> copy <!--[--><!--]--></a><!----></li><li><a href="/design/storage.html" class="sidebar-item" aria-label="store"><!--[--><!--]--> store <!--[--><!--]--></a><!----></li><li><a href="/design/memory.html" class="sidebar-item" aria-label="Memory Database"><!--[--><!--]--> Memory Database <!--[--><!--]--></a><!----></li><li><a href="/design/index_.html" class="sidebar-item" aria-label="index"><!--[--><!--]--> index <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><!--]--></ul><!--]--></div><!--]--></div><div class="scrollbar-rail scrollbar-rail--vertical" aria-hidden="true"><!----></div><div class="scrollbar-rail scrollbar-rail--horizontal" aria-hidden="true"><!----></div></div></aside><!--]--><!--[--><main class="page"><div class="with-toc theme-default-content theme-lin-content-wrap"><div class="theme-lin-content"><!--[--><h1 id="coordinator" tabindex="-1"><a class="header-anchor" href="#coordinator" aria-hidden="true">#</a> Coordinator</h1><h2 id="overview" tabindex="-1"><a class="header-anchor" href="#overview" aria-hidden="true">#</a> Overview</h2><p>Why does the Broker provide the important coordination of the entire cluster?</p><ul><li>Broker is actually a compute node which executes the reading and writing operations. Because the Broker needs to know the status information of all Storage nodes, so it performs the coordination tasks;</li><li>Metadata changes are not very frequent and are lightweight.</li><li>Storage nodes status changes are frequent, Broker picks the available shards by those information, so it&#39;s not necessary to let Storage managing the statues and then synchronize to the Broker. The advantage is that Storage can focus on storage things.</li><li>Computing ability of a certain database is required across multi IDCs.</li></ul><p>What information needs to be processes?</p><ul><li>database DDL operations;</li><li>Storage node management;</li><li>runtime parameter adjustment;</li><li>Storage/Broker state management;</li></ul><p>All coordination and scheduling operations are done based on ETCD. All scheduling messages require a version number to track whether the data on each node is consistent anymore after each node changes in Metadata.</p><h2 id="master" tabindex="-1"><a class="header-anchor" href="#master" aria-hidden="true">#</a> Master</h2><p>The master node is responsible for the main Metadata changes. Master is elected from current surviving Broker nodes preemptively. Each Broker node registers the Master Key at the same time, then whoever registers firstly becomes the Master.</p><p>At the same time, each Broker will also watch Master Key, If the information on Master Key is lost, the election will be re-elected, so that every Broker node will knows who is Master.</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>- Master Key: /master/node
- Registered Key: /master/node/{broker node}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="task" tabindex="-1"><a class="header-anchor" href="#task" aria-hidden="true">#</a> Task</h2><p>The task mentioned here mainly refers to the Storage node&#39;s received tasks which are sent by Master(Broker). It mainly includes the following two roles:</p><ul><li>Controller;</li><li>Executor;</li></ul><p>The ETCD related Keys are as follows:</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>- Task Key: /task-coordinator/v1/executor/{storage node id}/kinds/{task kind}/names/{task name}
- Task Status Key: /task-coordinator/v1/status/kinds/{task kind}/names/{task name}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="controller" tabindex="-1"><a class="header-anchor" href="#controller" aria-hidden="true">#</a> Controller:</h4><p>The controller runs at the Broker layer:</p><ul><li>Task generation(Task Key): The controller accepts the task submitted by the Master(Broker), then generates a specific Task and send it to the Storage node. The delivery operation is done by ETCD;</li><li>Task status Tracker(Task status Key): A Task status tracker is generated while task is delivered to track specific Task execution status;</li></ul><h4 id="executor" tabindex="-1"><a class="header-anchor" href="#executor" aria-hidden="true">#</a> Executor</h4><p>Executor runs on the Storage layer:</p><ul><li>Executing the task: Executor will execute the task by watching corresponding Task Key modification;</li><li>Task status update: Executor will update the report of execution result to the corresponding Task Status Key;</li></ul><h2 id="state-machine" tabindex="-1"><a class="header-anchor" href="#state-machine" aria-hidden="true">#</a> State Machine</h2><p>All of these operations are done by a variety of different state machines, each of which is described below. Different State Machines will watch the Keys on different ETCDs to perform the corresponding operations.</p><h3 id="broker-node-state-machine" tabindex="-1"><a class="header-anchor" href="#broker-node-state-machine" aria-hidden="true">#</a> Broker Node State Machine</h3><p>The State Machine runs on each Broker node, it performs the discovery of the Broker Node.</p><p><code>Watch Key: /active/nodes</code></p><ul><li>When the broker starts, it will register its information to the Watched Key(/active/nodes/{broker node});</li><li>When watched Key changed, every Broker knows which nodes are still alive;</li></ul><h3 id="storage-cluster-status-state-machine" tabindex="-1"><a class="header-anchor" href="#storage-cluster-status-state-machine" aria-hidden="true">#</a> Storage Cluster Status State Machine</h3><p>This State Machine runs on each Broker node, it performs the tracking of the survival status of each node in the Storage Cluster.</p><p><code>Watch Key: /state/storage/cluster</code></p><ul><li>The information of Watch Key is written by the Master. The Master will watch the survival of each node in Storage Cluster and write the final information to the corresponding Key(/state/storage/cluster/{cluster name}). For details see <a aria-current="page" href="/design/coordinator.html#storage-cluster-state-machine" class="router-link-active router-link-exact-active">Storage Cluster State Machine</a>;</li><li>Status information of each Storage Cluster is available by Broker watched Key change;</li><li>Broker will create a copy channel to Storage according to the situation of the Storage Cluster node and the information of the current Broker WAL. Once the channel is established, the data can be copied. For details see <a href="/design/replication.html" class="">Replication</a> ；</li></ul><h3 id="db-admin-state-machine" tabindex="-1"><a class="header-anchor" href="#db-admin-state-machine" aria-hidden="true">#</a> DB Admin State Machine</h3><p>The State Machine runs on each Master, it will primarily performs the database-related DDL.</p><p><code>Watch Key: /database/config</code></p><ul><li>User can submits the database DDL to any Broker node, then the node does not generate a specific Task for Storage but just write the configuration to &quot;/database/config/{db name}&quot;;</li><li>Shard assignment is created by current Storage cluster status by watching the Master Key;</li><li>Task is generated by shard assignment which will be delivered to the corresponding Storage node to perform DDL operation;</li></ul><p>Shard Assignment is information about each Shard which contains these details:</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>Name: database name
Nodes: Shard Replica of the located Storage Nodes
Shards: Information about each Shard


Each shard contains the following information:
ShardID: ID of the corresponding Shard:
Replicas: Information about all Replicas to the Shard, which corresponds to the information of the Nodes above. 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="storage-cluster-state-machine" tabindex="-1"><a class="header-anchor" href="#storage-cluster-state-machine" aria-hidden="true">#</a> Storage Cluster State Machine</h3><p>This State Machine runs on the Master, it performs the operation of configuration of Storage Cluster.</p><p><code>Watch Key: /storage/cluster/config</code></p><ul><li>User can submits configuration to each Broker node which will simply writes the configuration to &quot;/storage/cluster/config/{cluster name}&quot;;</li><li>A Storage Cluster Watch mechanism is established for each cluster to track the survival status of each node;</li><li>The survival or the Storage Node is watched and the status of the entire Storage will be wrote to &quot;/state/storage/cluster/{cluster name}&quot; for <a aria-current="page" href="/design/coordinator.html#storage-cluster-status-state-machine" class="router-link-active router-link-exact-active">Storage Cluster Status State Machine</a>&#39;s usage;</li></ul><p>The watch mechanism of each cluster is as follows:</p><ul><li>Establish a relationship with the Storage Cluster ETCD based on the configuration;</li><li>Watch alive key of Storage nodes: <code>/active/nodes(note that it&#39;s different from the broker)</code>;</li><li>Node information is registered to <code>/active/nodes/{storage node id}</code> when Storage node starts;</li></ul><h3 id="replicator-state-machine" tabindex="-1"><a class="header-anchor" href="#replicator-state-machine" aria-hidden="true">#</a> Replicator State Machine</h3><p>This State Machine runs on the Broker, it primarily performs the replication of shard WAL for each database.</p><p><code>Watch Key: /database/assign</code></p><ul><li>Watch Key change: Relationship of each Shard WAL of the database and the target Storage node is generated according to Shard Assignment. For details see <a aria-current="page" href="/design/coordinator.html#db-admin-state-machine" class="router-link-active router-link-exact-active">DB Admin State Machine</a>;</li><li>Note that it&#39;s just establishing a relationship instead of creating a copy channel;</li></ul><h3 id="replica-status-state-machine" tabindex="-1"><a class="header-anchor" href="#replica-status-state-machine" aria-hidden="true">#</a> Replica Status State Machine</h3><p>This State Machine runs on the Broker, it primarily performs monitoring the replication status of each Replicas;</p><p><code>Watch Key: /state/replica</code></p><ul><li>WAL replication periodically reports current replication status to the corresponding key (&quot;/state/replica/{storage node id}&quot;);</li><li>The status of each copy channel is available by watching <code>Broker Watch Key</code>, then the latest Storage node will be chosen when executing the query;</li><li>The status of all replicas under Broker Nodes to Storage nodes peer may include the replication status of multiple different database copies;</li></ul><h2 id="fault-tolerance" tabindex="-1"><a class="header-anchor" href="#fault-tolerance" aria-hidden="true">#</a> Fault tolerance</h2><ul><li>ETCD is a very central component during the process, as all coordination and scheduling information is done by it;</li><li>Metadata is also stored in ETCD;</li></ul><p>So if the ETCD is down, there will be a big impact on the whole system, then how to minimize the impact is critical:</p><ol><li>Firstly, if ETCD is down,. In the extreme case, the data corruption in the ETCD won&#39;t be recovered. Therefore, the relevant node need to perform local backup operations after each Metadata change, and have the ability to restore the new data to new ETCD cluster;</li><li>ETCD failures should not affect the availability of the entire system;</li><li>Generally, the Metadata change is low frequency operation, so it&#39;s acceptable;</li><li>If replication of Leader is corrupt, the replication data may be inconsistent;</li></ol><!--]--><footer class="page-meta"><div class="meta-item edit-link"><a class="external-link meta-item-label" href="https://github.com/lindb/lindb.github.io/edit/dev/docs/design/coordinator.md" rel="noopener noreferrer" target="_blank" aria-label="Edit this page"><!--[--><!--]--> Edit this page <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><div class="meta-item last-updated"><span class="meta-item-label">Last Updated: </span><!----></div><div class="meta-item contributors"><span class="meta-item-label">Contributors: </span><span class="meta-item-info"><!--[--><!--[--><span class="contributor" title="email: stonejh1100@gmail.com">stone1100</span><!----><!--]--><!--]--></span></div></footer><nav class="page-nav"><p class="inner"><span class="prev"><a href="/design/architecture.html" class="" aria-label="Architecture"><!--[--><!--]--> Architecture <!--[--><!--]--></a></span><span class="next"><a href="/design/query.html" class="" aria-label="Query"><!--[--><!--]--> Query <!--[--><!--]--></a></span></p></nav></div><div class="toc-wrap"><div class="scrollbar"><div class="scrollbar-container"><!--[--><div class="scrollbar-content" style=""><!--[--><div class="theme-lin-toc"><div class="toc-mask"></div><button class="mobile-toc-title"><svg fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" shape-rendering="geometricPrecision" viewbox="0 0 24 24" height="1.5em" width="1.5em" style="color:currentcolor;"><path d="M21 10H7M21 6H3M21 14H3M21 18H7"></path></svg></button><div class="toc-items-wrap"><div class="toc-nav-text">On this page</div><ul class="toc-items"><!--[--><li class="toc-item toc-level-2"><a class="toc-anchor" href="#overview">Overview</a></li><li class="toc-item toc-level-2"><a class="toc-anchor" href="#master">Master</a></li><li class="toc-item toc-level-2"><a class="toc-anchor" href="#task">Task</a></li><li class="toc-item toc-level-4"><a class="toc-anchor" href="#controller">Controller:</a></li><li class="toc-item toc-level-4"><a class="toc-anchor" href="#executor">Executor</a></li><li class="toc-item toc-level-2"><a class="toc-anchor" href="#state-machine">State Machine</a></li><li class="toc-item toc-level-3"><a class="toc-anchor" href="#broker-node-state-machine">Broker Node State Machine</a></li><li class="toc-item toc-level-3"><a class="toc-anchor" href="#storage-cluster-status-state-machine">Storage Cluster Status State Machine</a></li><li class="toc-item toc-level-3"><a class="toc-anchor" href="#db-admin-state-machine">DB Admin State Machine</a></li><li class="toc-item toc-level-3"><a class="toc-anchor" href="#storage-cluster-state-machine">Storage Cluster State Machine</a></li><li class="toc-item toc-level-3"><a class="toc-anchor" href="#replicator-state-machine">Replicator State Machine</a></li><li class="toc-item toc-level-3"><a class="toc-anchor" href="#replica-status-state-machine">Replica Status State Machine</a></li><li class="toc-item toc-level-2"><a class="toc-anchor" href="#fault-tolerance">Fault tolerance</a></li><!--]--></ul></div></div><!--]--></div><!--]--></div><div class="scrollbar-rail scrollbar-rail--vertical" aria-hidden="true"><!----></div><div class="scrollbar-rail scrollbar-rail--horizontal" aria-hidden="true"><!----></div></div></div></div></main><!--]--></div><div class="lin-footer"><div class="text"> Copyright © 2022 LinDB. All Rights Reserved. </div></div><!--]--><!----><!--]--></div>
    <script type="module" src="/assets/app.1245c310.js" defer></script>
  </body>
</html>
