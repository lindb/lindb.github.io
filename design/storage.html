<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.45">
    <style>
      :root {
        --c-bg: #fff;
      }
      html.dark {
        --c-bg: #22272e;
      }
      html, body {
        background-color: var(--c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme');
			const systemDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
			if (userMode === 'dark' || (userMode !== 'light' && systemDarkMode)) {
				document.documentElement.classList.toggle('dark', true);
			}
    </script>
    <link rel="icon" href="/images/logo.png"><link rel="stylesheet" type="text/css" href="//at.alicdn.com/t/font_1331329_he22yc3ekc6.css"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>store | LinDB</title><meta name="description" content="A distributed time series database">
    <link rel="modulepreload" href="/assets/app.1245c310.js"><link rel="modulepreload" href="/assets/storage.html.a70208fd.js"><link rel="modulepreload" href="/assets/storage_sstable.3c2f1559.js"><link rel="modulepreload" href="/assets/storage_database.22d441e2.js"><link rel="modulepreload" href="/assets/storage.html.9d3cf863.js"><link rel="prefetch" href="/assets/index.html.b7727a54.js"><link rel="prefetch" href="/assets/project-layout.html.a4629c0e.js"><link rel="prefetch" href="/assets/architecture.html.103f1cb2.js"><link rel="prefetch" href="/assets/coordinator.html.e33865cf.js"><link rel="prefetch" href="/assets/index_.html.79572b7d.js"><link rel="prefetch" href="/assets/memory.html.3307ef46.js"><link rel="prefetch" href="/assets/query.html.83857a74.js"><link rel="prefetch" href="/assets/replication.html.d8debbb6.js"><link rel="prefetch" href="/assets/admin-ui.html.7e59a287.js"><link rel="prefetch" href="/assets/api.html.973e558b.js"><link rel="prefetch" href="/assets/configuration.html.3111e0ba.js"><link rel="prefetch" href="/assets/installation.html.fdc905d0.js"><link rel="prefetch" href="/assets/overview.html.9a55cdf6.js"><link rel="prefetch" href="/assets/sql.html.8680f7c7.js"><link rel="prefetch" href="/assets/index.html.75e6b82c.js"><link rel="prefetch" href="/assets/datamodel.html.52b5cccd.js"><link rel="prefetch" href="/assets/dtomodel.html.7a4e905b.js"><link rel="prefetch" href="/assets/fieldtype.html.8b470ff4.js"><link rel="prefetch" href="/assets/comparision.html.2a5b8334.js"><link rel="prefetch" href="/assets/roadmap.html.10a03183.js"><link rel="prefetch" href="/assets/project-layout.html.238330e8.js"><link rel="prefetch" href="/assets/architecture.html.9d76a560.js"><link rel="prefetch" href="/assets/coordinator.html.6c762904.js"><link rel="prefetch" href="/assets/index_.html.0ba0078f.js"><link rel="prefetch" href="/assets/memory.html.3ea92e81.js"><link rel="prefetch" href="/assets/query.html.a40c8f20.js"><link rel="prefetch" href="/assets/replication.html.27d90e28.js"><link rel="prefetch" href="/assets/storage.html.32615d67.js"><link rel="prefetch" href="/assets/index.html.a4e417bb.js"><link rel="prefetch" href="/assets/admin-ui.html.7d72bb8a.js"><link rel="prefetch" href="/assets/api.html.06310af3.js"><link rel="prefetch" href="/assets/cli.html.43e41297.js"><link rel="prefetch" href="/assets/configuration.html.6c713c1e.js"><link rel="prefetch" href="/assets/glossary.html.4ecb27d8.js"><link rel="prefetch" href="/assets/installation.html.a5b7efe2.js"><link rel="prefetch" href="/assets/lql.html.42f1764d.js"><link rel="prefetch" href="/assets/overview.html.0f16248f.js"><link rel="prefetch" href="/assets/datamodel.html.56c2a7a8.js"><link rel="prefetch" href="/assets/dtomodel.html.4d240700.js"><link rel="prefetch" href="/assets/fieldtype.html.7b533eb5.js"><link rel="prefetch" href="/assets/comparision.html.3e14341b.js"><link rel="prefetch" href="/assets/roadmap.html.33cbcfc5.js"><link rel="prefetch" href="/assets/index.html.7bcd1f19.js"><link rel="prefetch" href="/assets/explore.html.3ef2d05c.js"><link rel="prefetch" href="/assets/metadata.html.1bb86786.js"><link rel="prefetch" href="/assets/monitoring.html.bcb64307.js"><link rel="prefetch" href="/assets/overview.html.4b875951.js"><link rel="prefetch" href="/assets/search.html.7d7e41d0.js"><link rel="prefetch" href="/assets/404.html.f166316b.js"><link rel="prefetch" href="/assets/index.html.953850bf.js"><link rel="prefetch" href="/assets/project-layout.html.5f948252.js"><link rel="prefetch" href="/assets/architecture.html.29886a84.js"><link rel="prefetch" href="/assets/coordinator.html.913f65ca.js"><link rel="prefetch" href="/assets/index_.html.ea40a59c.js"><link rel="prefetch" href="/assets/memory.html.ce24a23b.js"><link rel="prefetch" href="/assets/query.html.fb1f5ea1.js"><link rel="prefetch" href="/assets/replication.html.37b73804.js"><link rel="prefetch" href="/assets/admin-ui.html.2ed083ff.js"><link rel="prefetch" href="/assets/api.html.d89b9dfb.js"><link rel="prefetch" href="/assets/configuration.html.bf66527b.js"><link rel="prefetch" href="/assets/installation.html.c10a6549.js"><link rel="prefetch" href="/assets/overview.html.0348273a.js"><link rel="prefetch" href="/assets/sql.html.27baae5e.js"><link rel="prefetch" href="/assets/index.html.e72dc124.js"><link rel="prefetch" href="/assets/datamodel.html.c025c119.js"><link rel="prefetch" href="/assets/dtomodel.html.f4fc5e15.js"><link rel="prefetch" href="/assets/fieldtype.html.97cd5b90.js"><link rel="prefetch" href="/assets/comparision.html.411af8eb.js"><link rel="prefetch" href="/assets/roadmap.html.a3cb2bb6.js"><link rel="prefetch" href="/assets/project-layout.html.f94f32bd.js"><link rel="prefetch" href="/assets/architecture.html.80414f89.js"><link rel="prefetch" href="/assets/coordinator.html.8ec46303.js"><link rel="prefetch" href="/assets/index_.html.43b6e4ad.js"><link rel="prefetch" href="/assets/memory.html.a79e7fc0.js"><link rel="prefetch" href="/assets/query.html.877c67b5.js"><link rel="prefetch" href="/assets/replication.html.2ae34cc1.js"><link rel="prefetch" href="/assets/storage.html.ebb9bbff.js"><link rel="prefetch" href="/assets/index.html.805a8131.js"><link rel="prefetch" href="/assets/admin-ui.html.89067a62.js"><link rel="prefetch" href="/assets/api.html.3dfd1506.js"><link rel="prefetch" href="/assets/cli.html.95331d53.js"><link rel="prefetch" href="/assets/configuration.html.34943d8c.js"><link rel="prefetch" href="/assets/glossary.html.0507f024.js"><link rel="prefetch" href="/assets/installation.html.770a8b95.js"><link rel="prefetch" href="/assets/lql.html.be4f3a62.js"><link rel="prefetch" href="/assets/overview.html.4df29ceb.js"><link rel="prefetch" href="/assets/datamodel.html.5266ce24.js"><link rel="prefetch" href="/assets/dtomodel.html.f4be2ad4.js"><link rel="prefetch" href="/assets/fieldtype.html.5f24c4f4.js"><link rel="prefetch" href="/assets/comparision.html.1b1d6fa7.js"><link rel="prefetch" href="/assets/roadmap.html.3b37b0e4.js"><link rel="prefetch" href="/assets/index.html.879f33c3.js"><link rel="prefetch" href="/assets/explore.html.cf540522.js"><link rel="prefetch" href="/assets/metadata.html.d565de8f.js"><link rel="prefetch" href="/assets/monitoring.html.95a08391.js"><link rel="prefetch" href="/assets/overview.html.b70b858c.js"><link rel="prefetch" href="/assets/search.html.62be0060.js"><link rel="prefetch" href="/assets/404.html.6fe00063.js"><link rel="prefetch" href="/assets/404.d585f2dc.js"><link rel="prefetch" href="/assets/Layout.479720ed.js"><link rel="prefetch" href="/assets/HomeBackgroundCanvas.7152b788.js"><link rel="prefetch" href="/assets/HomePage.0486f96b.js"><link rel="prefetch" href="/assets/ImageWindow.43b43422.js"><link rel="prefetch" href="/assets/IntroItem.f7b52abc.js"><link rel="prefetch" href="/assets/IntroList.5be15e35.js"><link rel="prefetch" href="/assets/LinFooter.4ab9a6cd.js"><link rel="prefetch" href="/assets/Page.c15baf89.js"><link rel="prefetch" href="/assets/Scrollbar.75566d90.js"><link rel="prefetch" href="/assets/Sidebar.b58d2f9d.js"><link rel="prefetch" href="/assets/Toc.a71f3d4e.js">
    <link rel="stylesheet" href="/assets/style.51733ec4.css">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><div class="theme-container"><!--[--><header class="navbar"><div class="toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a href="/" class=""><!----><span class="site-name can-hide">LinDB</span></a></span><div class="navbar-items-wrapper" style=""><!--[--><!--]--><nav class="navbar-items can-hide"><!--[--><div class="navbar-item"><a href="/guide/overview" class="" aria-label="Guide"><!--[--><!--]--> Guide <!--[--><!--]--></a></div><div class="navbar-item"><a href="/design/architecture" class="" aria-label="Design"><!--[--><!--]--> Design <!--[--><!--]--></a></div><div class="navbar-item"><a href="/community/project-layout" class="" aria-label="Community"><!--[--><!--]--> Community <!--[--><!--]--></a></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="Select language"><span class="title">Languages</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="Select language"><span class="title">Languages</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a aria-current="page" href="/design/storage.html" class="router-link-active router-link-exact-active router-link-active" aria-label="English"><!--[--><!--]--> English <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/zh/design/storage.html" class="" aria-label="简体中文"><!--[--><!--]--> 简体中文 <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-item"><a class="external-link" href="https://github.com/lindb/lindb" rel="noopener noreferrer" target="_blank" aria-label="GitHub"><!--[--><!--]--> GitHub <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button class="toggle-dark-button" title="toggle dark mode"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><form class="search-box" role="search"><input type="search" autocomplete="off" spellcheck="false" value><!----></form></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><div class="scrollbar"><div class="scrollbar-container"><!--[--><div class="scrollbar-content" style=""><!--[--><nav class="navbar-items"><!--[--><div class="navbar-item"><a href="/guide/overview" class="" aria-label="Guide"><!--[--><!--]--> Guide <!--[--><!--]--></a></div><div class="navbar-item"><a href="/design/architecture" class="" aria-label="Design"><!--[--><!--]--> Design <!--[--><!--]--></a></div><div class="navbar-item"><a href="/community/project-layout" class="" aria-label="Community"><!--[--><!--]--> Community <!--[--><!--]--></a></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="Select language"><span class="title">Languages</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="Select language"><span class="title">Languages</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a aria-current="page" href="/design/storage.html" class="router-link-active router-link-exact-active router-link-active" aria-label="English"><!--[--><!--]--> English <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/zh/design/storage.html" class="" aria-label="简体中文"><!--[--><!--]--> 简体中文 <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-item"><a class="external-link" href="https://github.com/lindb/lindb" rel="noopener noreferrer" target="_blank" aria-label="GitHub"><!--[--><!--]--> GitHub <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><!--]--></nav><ul class="sidebar-items"><!--[--><li><p tabindex="0" class="sidebar-item sidebar-heading active">Design <!----></p><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a href="/design/architecture.html" class="sidebar-item" aria-label="Architecture"><!--[--><!--]--> Architecture <!--[--><!--]--></a><!----></li><li><a href="/design/coordinator.html" class="sidebar-item" aria-label="Coordinator"><!--[--><!--]--> Coordinator <!--[--><!--]--></a><!----></li><li><a href="/design/query.html" class="sidebar-item" aria-label="Query"><!--[--><!--]--> Query <!--[--><!--]--></a><!----></li><li><a href="/design/replication.html" class="sidebar-item" aria-label="copy"><!--[--><!--]--> copy <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/design/storage.html" class="router-link-active router-link-exact-active router-link-active sidebar-item active" aria-label="store"><!--[--><!--]--> store <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/design/storage.html#timing-characteristics" class="router-link-active router-link-exact-active sidebar-item" aria-label="Timing Characteristics"><!--[--><!--]--> Timing Characteristics <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/design/storage.html#storage-structure" class="router-link-active router-link-exact-active sidebar-item" aria-label="storage structure"><!--[--><!--]--> storage structure <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/design/storage.html#database" class="router-link-active router-link-exact-active sidebar-item" aria-label="Database"><!--[--><!--]--> Database <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/design/storage.html#shard" class="router-link-active router-link-exact-active sidebar-item" aria-label="Shard"><!--[--><!--]--> Shard <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a aria-current="page" href="/design/storage.html#kv-store" class="router-link-active router-link-exact-active sidebar-item" aria-label="KV Store"><!--[--><!--]--> KV Store <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/design/storage.html#compaction" class="router-link-active router-link-exact-active sidebar-item" aria-label="Compaction"><!--[--><!--]--> Compaction <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/design/storage.html#rollup" class="router-link-active router-link-exact-active sidebar-item" aria-label="Rollup"><!--[--><!--]--> Rollup <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/design/storage.html#sstable-layout" class="router-link-active router-link-exact-active sidebar-item" aria-label="SSTable Layout"><!--[--><!--]--> SSTable Layout <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><!--]--></ul><!--]--></li><li><a href="/design/memory.html" class="sidebar-item" aria-label="Memory Database"><!--[--><!--]--> Memory Database <!--[--><!--]--></a><!----></li><li><a href="/design/index_.html" class="sidebar-item" aria-label="index"><!--[--><!--]--> index <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><!--]--></ul><!--]--></div><!--]--></div><div class="scrollbar-rail scrollbar-rail--vertical" aria-hidden="true"><!----></div><div class="scrollbar-rail scrollbar-rail--horizontal" aria-hidden="true"><!----></div></div></aside><!--]--><!--[--><main class="page"><div class="with-toc theme-default-content theme-lin-content-wrap"><div class="theme-lin-content"><!--[--><h1 id="store" tabindex="-1"><a class="header-anchor" href="#store" aria-hidden="true">#</a> store</h1><p>All data of <code>LinDB</code> will be stored on the local disk, and there are different storage structures according to different data types:</p><ul><li><code>Metirc Metadata</code>: store <code>Metric Name</code> and its underlying <code>Fields</code>/<code>Tag Keys</code>;</li><li><code>Tags(Series) Index</code>: store all <code>Tags</code> under a <code>Metric</code>, this part is divided into <code>2</code> data types; <ul><li>Forward: <code>Tags</code> corresponding to <code>Series ID</code>;</li><li>Reverse: store the inverted index of <code>Tag Key/Value</code>, that is, which <code>Series ID</code> is under each <code>Tag Value</code>, <code>Series ID</code> is stored using <a href="http://roaringbitmap.org" target="_blank" rel="noopener noreferrer">RoaringBitMap<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> ;</li></ul></li><li><code>Data</code>: storage of <code>Data Point</code> under all <code>Time Series</code>;</li></ul><p>All of the above data types are stored in a common underlying <code>KV Store</code>.</p><h2 id="timing-characteristics" tabindex="-1"><a class="header-anchor" href="#timing-characteristics" aria-hidden="true">#</a> Timing Characteristics</h2><p>Before talking about storage, let&#39;s talk about the characteristics of timing, as shown in the figure:</p><p><img src="/assets/time_series_characteristic.50059496.png" alt="time series characteristic"></p><p>Time series data characteristics (according to its time characteristics, it can be divided into time-invariant and time-variant data)</p><ol><li><code>Time Series</code> =&gt; <code>Metric + Tags</code>: This part of the data is basically a string, and this data occupies the bulk of the data packet, but it will not change with time. Try to convert strings into numerical values ​​for storage to reduce storage costs;</li><li><code>Fields</code>: This part of the data is basically numeric and changes with time, but the numeric type is easy to compress;</li></ol><h2 id="storage-structure" tabindex="-1"><a class="header-anchor" href="#storage-structure" aria-hidden="true">#</a> storage structure</h2><h3 id="database" tabindex="-1"><a class="header-anchor" href="#database" aria-hidden="true">#</a> Database</h3><p><img src="/assets/storage_database.bca79d7d.png" alt="storage database"></p><ul><li>The data of a database is distributed on different nodes of the <code>Storage</code> cluster according to <code>Shard</code>;</li><li>A <code>Shard</code> can have multiple copies, please see <a href="/design/replication.html" class="">Replication</a> for details;</li></ul><h3 id="shard" tabindex="-1"><a class="header-anchor" href="#shard" aria-hidden="true">#</a> Shard</h3><div class="language-markdown ext-md"><pre class="language-markdown"><code>├─ db_test_1
| ├─ meta
| | ├─ namespace
| ├─ metric
| | ├─ field
| | ├─ tagkey
| └─ tagvalue
| └─ shard
| ├─ 1
| ├─ inverted
| ├─ forward
|  | └─ segment
|  | ├─ day
|  | | ├─ 20190101
|  | | | ├─ 01
|  | | | ├─ 02
|  | | | └─ 23
|| | └─ 20190102
|  | ├─ month
|  | | ├─ 201901
|  | | | ├─ 01
|  | | | ├─ 02
|  | | | └─ 31
|  | | └─ 201902
|  | └─ year
|  | ├─ 2019
|  | | ├─ 01
|  | | ├─ 02
|  | | └─ 12
|  | └─ 2020
| └─ 2
└─ db_test_2
</code></pre></div><p>The above is the storage directory structure of data on a <code>Storage</code> node, taking the data structure of a single database on a single node as an example:</p><ul><li><code>meta</code>: store all <code>metadata</code>, at database level: <ul><li><code>namespace</code></li><li><code>metric</code></li><li><code>field</code></li><li><code>tag key</code></li><li><code>tag value</code></li></ul></li><li><code>shard</code>: A database will have multiple <code>shard</code>s on a single node, and each <code>shard</code> has the following data: <ul><li><code>index</code>: store forward and reverse indexes;</li><li><code>segment</code>: store the data of each time slice;</li></ul></li></ul><p>See <a href="/design/index_.html" class="">index</a> for the structure of <code>meta</code> and <code>index</code>.</p><p>All data is calculated according to the <code>Interval</code> of the database to store specific data in time slices:</p><ul><li>The time series has strong time correlation, which can better handle data query;</li><li>It is convenient to handle <code>TTL</code>. If the data expires, just delete the corresponding directory directly;</li><li>There are multiple <code>segments</code> under each <code>shard</code>, and each <code>segment</code> stores the data of the corresponding time slice according to the corresponding <code>interval</code>;</li><li>Why are there many <code>data families</code> stored according to <code>interval</code> under each <code>segment</code>? This is mainly because the main problem solved by <code>LinDB</code> is to store a large amount of monitoring data. The general monitoring data is basically written at the latest time, and basically no historical data is written. The data storage of the entire <code>LinDB</code> is similar to the <code>LSM</code> method, so In order to reduce the merge operation between data files, which leads to write amplification, it is finally measured, and then the <code>segment</code> time slice is sharded.</li></ul><p>The following is an example of <code>interval</code> being <code>10s</code>:</p><ol><li><code>segment</code> is stored by day;</li><li>Each <code>segment</code> is divided into <code>data family</code> by hour, one <code>family</code> per hour, and the files in each <code>family</code> store specific data in columns;</li></ol><h2 id="kv-store" tabindex="-1"><a class="header-anchor" href="#kv-store" aria-hidden="true">#</a> KV Store</h2><div class="language-markdown ext-md"><pre class="language-markdown"><code>└─ kv_store_1
   ├─ CURRENT
   ├─ LOCK
   ├─ MANIFEST-000010
   ├─ OPTIONS
   ├─ family_1
   | ├─ 000001.sst
   | ├─ 000002.sst
   | ├─ 000004.sst
| └─ 000008.sst
   ├─ family_2
   | ├─ 000011.sst
   | ├─ 000012.sst
   | ├─ 000014.sst
| └─ 000018.sst
   └─ family_3
</code></pre></div><p>The whole <code>KV Store</code> is similar to <code>LSM</code>, but it is different from <code>LSM</code>. The main differences are as follows:</p><ul><li>There is no <code>Memory Table</code>, because the whole system will have a <code>Memory Database</code> to store all the data of the current period of time, and these data will be directly written to the <code>KV Store</code>;</li><li><code>Key</code> is all <code>uint32</code>, because all <code>string</code> will be converted to <code>uint32</code> according to the timing characteristics, so the underlying <code>KV Store</code> is directly designed as a <code>uint32 =&gt; binary</code> structure;</li></ul><p>The whole directory is very similar to <code>rocksdb</code> and supports <code>column family</code>.</p><ul><li><code>CURRENT</code>: record the currently valid <code>MANIFEST</code> file;</li><li><code>LOCK</code>: file lock to prevent multiple processes from opening the same <code>KV Store</code>;</li><li><code>MANIFEST</code>: <code>change log</code> of all <code>sstable</code> changes, including some <code>change log</code> of <code>sequence</code>, etc.;</li><li><code>OPTIONS</code>: <code>KV Store</code> configuration information, including configuration information at each <code>column family</code> level;</li><li><code>KV Store</code> can store multiple <code>column families</code>, and each <code>family</code> stores multiple <code>sstable</code> files;</li></ul><h3 id="compaction" tabindex="-1"><a class="header-anchor" href="#compaction" aria-hidden="true">#</a> Compaction</h3><p><img src="/assets/storage_compaction.d6f1f39f.png" alt="storage compaction"></p><ul><li>Each <code>KV Store</code> will start a <code>Goroutine</code> periodically to <code>Check</code> whether there are too many files in each <code>Family Level 0</code> and meet the conditions of <code>Compaction</code>;</li><li>How to satisfy the condition, the corresponding <code>Family</code> will be notified to execute <code>Compaction Job</code>, if there is already <code>Compaction</code> being executed, this operation will be ignored, the whole operation will only be completed in one <code>Goroutine</code>, the advantage of this is that the whole operation It is a lock-free operation, because <code>Compaction Job</code> is a very heavy operation, and if locking is required, it may affect the writing of new files</li></ul><p><code>Compaction</code> mainly merges the files in <code>Level 0</code> into <code>Level 1</code>. Currently, <code>LinDB</code> has only <code>Level 2</code>, which is different from <code>LevelDB</code>.</p><p><code>Compaction</code> condition, any one of the following conditions will trigger the Compact task:</p><ul><li>the number of files in <code>Level 0</code> exceeds the number of files configured;</li></ul><p>The merge process will currently have <code>2</code> classes:</p><ul><li>Directly move the files of <code>Level 0</code> to <code>Level 1</code>, but need to meet the conditions of <code>compact</code>, the number of files of <code>pick files from level 0</code> is <code>1</code>, the number of files of <code>pick fiels from level 1</code> is <code>1</code> The number of files is <code>0</code>, that is, only one file needs to be merged, just modify <code>Metadata</code>;</li><li>Need to combine multiple files into one large file;</li></ul><p>The <code>Compact</code> process is as follows:</p><ol><li>Select the file that needs <code>Compact</code>, first select the current <code>level 0</code> file, then traverse each <code>level 0</code> file, press <code>key range</code> to get the overlapping file from <code>level 1</code>, why is here? Fetch <code>level 1</code> files by each <code>level 0</code> file, not by the final <code>key range</code> in <code>level 0</code>. Because the <code>keys</code> of the entire <code>level 0</code> file may be relatively hashed, so if you take the final <code>range</code>, you may get a large range. E.g:</li></ol><div class="language-yaml ext-yml"><pre class="language-yaml"><code><span class="token key atrule">for example</span><span class="token punctuation">:</span>
<span class="token key atrule">Level 0</span><span class="token punctuation">:</span>
    <span class="token key atrule">file 1</span><span class="token punctuation">:</span> 1~10
    <span class="token key atrule">file 2</span><span class="token punctuation">:</span> 1000~1001
    
<span class="token key atrule">Level 1</span><span class="token punctuation">:</span>
    <span class="token key atrule">file 3</span><span class="token punctuation">:</span> 1~5
    <span class="token key atrule">file 4</span><span class="token punctuation">:</span> 100~200
    <span class="token key atrule">file 5</span><span class="token punctuation">:</span> 400~500
    
<span class="token punctuation">-</span> If you press the final range of level 0<span class="token punctuation">,</span> 1~1001<span class="token punctuation">,</span> this will take out all the files of level 1
<span class="token punctuation">-</span> If you take it according to the range of each level 0<span class="token punctuation">,</span> you only need to take the file 3 (1~5) in the end.
</code></pre></div><ol start="2"><li>The entire <code>compact</code> process is actually a multi-way merge process. Since the <code>key</code> is sorted when <code>flush</code> writes files, <code>compact</code> only needs to read each file in order, and press <code> The order of key</code> can traverse the data from these files;</li></ol><ul><li>During the process, the data with the same <code>key</code> needs to be merged. The merging process needs to be merged according to different data types, and the <code>Merger Interface</code> needs to be implemented;</li><li>If <code>key</code> does not need the merge operation, write the corresponding data directly to the file, which can reduce unnecessary serialization operations;</li></ul><ol start="3"><li><code>compact</code> merging and writing files is successfully completed. You need to submit <code>Version Edit</code> to <code>Version Set</code>. At this time, <code>Version Edit</code> includes newly written files and old files that need to be deleted. This process requires locks;</li><li>Delete some useless files, such as files that have been merged, or some intermediate result files after failure. It should be noted here that the cleanup operation must be done after the <code>Version Edit</code> is successfully submitted to the <code>Version Set</code>, otherwise It will lead to the problem of data file confusion;</li></ol><div class="custom-container tip"><p class="custom-container-title">TIP</p><ul><li>Version Edit: Similar to LevelDB, a Version Edit will be recorded for each file write operation, and Version Edit will record new files/deleted files, so that when the system restarts or crashes, just reload the Version Edit Log again. There are those that mention the whole useful document;</li><li>Version Set: record which files are currently stored and available;</li></ul></div><h3 id="rollup" tabindex="-1"><a class="header-anchor" href="#rollup" aria-hidden="true">#</a> Rollup</h3><p><img src="/assets/storage_rollup.57223aba.png" alt="storage sstable"></p><p><code>Rollup Job</code> is a special <code>Compact Job</code>, which mainly deals with data reduction (<code>Downsampling</code>), namely <code>10s-&gt;5m-&gt;1h</code>, its core logic is the same as <code>Compaction Job</code>, the main differences are as follows :</p><ol><li><code>Source Family</code> merges data into <code>Target Family</code> to operate <code>2</code> <code>Family</code>;</li><li>After the merging is completed, delete the files that need <code>Rollup</code> in <code>Source Family Version</code>, and record the files that have been <code>Rollup</code> in <code>Target Family Version</code> to prevent duplicate data merging;</li></ol><h3 id="sstable-layout" tabindex="-1"><a class="header-anchor" href="#sstable-layout" aria-hidden="true">#</a> SSTable Layout</h3><p><img src="/assets/storage_sstable.f2c30503.png" alt="storage sstable"></p><p>The structure of each <code>SSTable</code> is shown in the figure above, and it mainly has the following components:</p><ul><li><code>Footer Block</code>: Mainly store <code>Margic Number(8 Bytes) + Version(1 byte) + Index Block Offset(4 bytes) + Offset Block Offset(4 bytes)</code>, which can be accessed through <code>Index Block Offset</code> and <code>Offset Block</code> Offset<code>The two </code>Offset<code>read the contents of</code>Index Block<code>and</code>Offset Block`;</li><li><code>Index Block</code>: use <code>Roaring Bitmap</code> to store all the <code>Keys</code> in the current <code>SSTable</code> file, because all <code>Key</code> are <code>uint32</code>, so you can directly use <code>Roaring Bitmap</code> to store, such benefits Yes, you can use <code>Roaring Bitmap</code> to determine whether a <code>Key</code> exists, and at the same time you can also know the position of this <code>Key</code> in this <code>Roaring Bitmap</code>;</li><li><code>Offset Block</code>: store all the <code>Offset</code> of <code>Value Entry</code>, and each <code>Offset</code> is stored with a fixed length, so if it is found in the <code>Nth</code> position in the <code>Index Block</code>, The <code>Offset</code> of that <code>Value Entry</code> is the data pointed to by <code>N * Offset Length</code>;</li><li><code>Value Entry</code>: store the <code>Value</code> corresponding to each <code>Key/Value</code>, because the <code>Key</code> is already stored in the <code>Index Block</code>, so the <code>Value Entry</code> only needs to store the <code>Value</code> in the <code>Key/Value</code> `You can;</li></ul><p>The advantage of this is that the compression of <code>Key</code> can be done well, and <code>Roaring Bitmap</code> has done a lot of optimization on <code>Bitmap</code>, <code>Get</code> data through <code>Key</code> is very efficient, because it is not like <code>LevelDB</code> In that case, the <code>Key</code> needs to be queried in the middle, and the <code>Bitmap</code> can be resident in memory.</p><p>Based on the above storage structure, the entire query logic is as follows:</p><ol><li>Through <code>Index Block</code>, you can directly know whether the queried <code>Key</code> exists. If it does not exist, return it directly. If it exists, get the first position (<code>Index</code>) in the <code>Bitmap</code>;</li><li>First jump: According to the <code>Index</code> obtained above, in <code>Offset Block</code>, after skipping <code>Index * Offset Length</code>, you can get <code>Value Entry Offset(Position)</code>;</li><li>The second jump: According to the <code>Position</code> obtained above, skip the <code>Position</code> at the beginning of the file and then the desired <code>Value</code> can be read directly;</li></ol><p>If you want to do the <code>Scan</code> operation, you can directly read the sequence based on the <code>Index Block</code> and <code>Offset Blcok</code>.</p><h4 id="refer-to" tabindex="-1"><a class="header-anchor" href="#refer-to" aria-hidden="true">#</a> refer to</h4><ol><li><a href="http://roaringbitmap.org" target="_blank" rel="noopener noreferrer">RoaringBitMap<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li><a href="http://opentsdb.net/docs/build/html/user_guide/uids.html" target="_blank" rel="noopener noreferrer">OpenTSDB UID<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li><a href="https://rocksdb.org/" target="_blank" rel="noopener noreferrer">RocksDB<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li></ol><!--]--><footer class="page-meta"><div class="meta-item edit-link"><a class="external-link meta-item-label" href="https://github.com/lindb/lindb.github.io/edit/dev/docs/design/storage.md" rel="noopener noreferrer" target="_blank" aria-label="Edit this page"><!--[--><!--]--> Edit this page <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><div class="meta-item last-updated"><span class="meta-item-label">Last Updated: </span><!----></div><div class="meta-item contributors"><span class="meta-item-label">Contributors: </span><span class="meta-item-info"><!--[--><!--[--><span class="contributor" title="email: stonejh1100@gmail.com">stone1100</span><!----><!--]--><!--]--></span></div></footer><nav class="page-nav"><p class="inner"><span class="prev"><a href="/design/replication.html" class="" aria-label="copy"><!--[--><!--]--> copy <!--[--><!--]--></a></span><span class="next"><a href="/design/memory.html" class="" aria-label="Memory Database"><!--[--><!--]--> Memory Database <!--[--><!--]--></a></span></p></nav></div><div class="toc-wrap"><div class="scrollbar"><div class="scrollbar-container"><!--[--><div class="scrollbar-content" style=""><!--[--><div class="theme-lin-toc"><div class="toc-mask"></div><button class="mobile-toc-title"><svg fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" shape-rendering="geometricPrecision" viewbox="0 0 24 24" height="1.5em" width="1.5em" style="color:currentcolor;"><path d="M21 10H7M21 6H3M21 14H3M21 18H7"></path></svg></button><div class="toc-items-wrap"><div class="toc-nav-text">On this page</div><ul class="toc-items"><!--[--><li class="toc-item toc-level-2"><a class="toc-anchor" href="#timing-characteristics">Timing Characteristics</a></li><li class="toc-item toc-level-2"><a class="toc-anchor" href="#storage-structure">storage structure</a></li><li class="toc-item toc-level-3"><a class="toc-anchor" href="#database">Database</a></li><li class="toc-item toc-level-3"><a class="toc-anchor" href="#shard">Shard</a></li><li class="toc-item toc-level-2"><a class="toc-anchor" href="#kv-store">KV Store</a></li><li class="toc-item toc-level-3"><a class="toc-anchor" href="#compaction">Compaction</a></li><li class="toc-item toc-level-3"><a class="toc-anchor" href="#rollup">Rollup</a></li><li class="toc-item toc-level-3"><a class="toc-anchor" href="#sstable-layout">SSTable Layout</a></li><li class="toc-item toc-level-4"><a class="toc-anchor" href="#refer-to">refer to</a></li><!--]--></ul></div></div><!--]--></div><!--]--></div><div class="scrollbar-rail scrollbar-rail--vertical" aria-hidden="true"><!----></div><div class="scrollbar-rail scrollbar-rail--horizontal" aria-hidden="true"><!----></div></div></div></div></main><!--]--></div><div class="lin-footer"><div class="text"> Copyright © 2022 LinDB. All Rights Reserved. </div></div><!--]--><!----><!--]--></div>
    <script type="module" src="/assets/app.1245c310.js" defer></script>
  </body>
</html>
