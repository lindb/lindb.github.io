<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Coordinator | LinDB</title>
    <meta name="description" content="分布式时序数据库">
    <meta name="keywords" content="lindb tsdb">
  <link rel="shortcut icon" href="/images/logo.png">
  <link rel="stylesheet" type="text/css" href="//at.alicdn.com/t/font_1331329_he22yc3ekc6.css">
    
    <link rel="preload" href="/assets/css/0.styles.e395b7c9.css" as="style"><link rel="preload" href="/assets/js/app.57b9579b.js" as="script"><link rel="preload" href="/assets/js/2.e103f43c.js" as="script"><link rel="preload" href="/assets/js/25.f96214da.js" as="script"><link rel="prefetch" href="/assets/js/10.99ee538d.js"><link rel="prefetch" href="/assets/js/11.af6ff590.js"><link rel="prefetch" href="/assets/js/12.855732cc.js"><link rel="prefetch" href="/assets/js/13.898dda41.js"><link rel="prefetch" href="/assets/js/14.276b4a91.js"><link rel="prefetch" href="/assets/js/15.58173395.js"><link rel="prefetch" href="/assets/js/16.81f780e6.js"><link rel="prefetch" href="/assets/js/17.b7829dca.js"><link rel="prefetch" href="/assets/js/18.8ae4162a.js"><link rel="prefetch" href="/assets/js/19.dadb5390.js"><link rel="prefetch" href="/assets/js/20.6f531f99.js"><link rel="prefetch" href="/assets/js/21.2574746d.js"><link rel="prefetch" href="/assets/js/22.25fbb40f.js"><link rel="prefetch" href="/assets/js/23.fd5d72e6.js"><link rel="prefetch" href="/assets/js/24.bf58f178.js"><link rel="prefetch" href="/assets/js/26.a391d9b3.js"><link rel="prefetch" href="/assets/js/27.a4c60592.js"><link rel="prefetch" href="/assets/js/28.11c1294d.js"><link rel="prefetch" href="/assets/js/29.91611e85.js"><link rel="prefetch" href="/assets/js/3.564ffec3.js"><link rel="prefetch" href="/assets/js/30.d4a54e58.js"><link rel="prefetch" href="/assets/js/4.aee1fce6.js"><link rel="prefetch" href="/assets/js/5.3678aae4.js"><link rel="prefetch" href="/assets/js/6.f0933b5b.js"><link rel="prefetch" href="/assets/js/7.dcf92b31.js"><link rel="prefetch" href="/assets/js/8.b4b6c1d9.js"><link rel="prefetch" href="/assets/js/9.3f5e65bd.js">
    <link rel="stylesheet" href="/assets/css/0.styles.e395b7c9.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/zh/" class="home-link router-link-active"><img src="/images/logo.png" alt="LinDB" class="logo"> <span class="site-name can-hide">LinDB</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/zh/docs/quick-start.html" class="nav-link">文档</a></div><div class="nav-item"><a href="/zh/docs/community/contributor-guide.html" class="nav-link">社区</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Select language" class="dropdown-title"><span class="title">选择语言</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/docs/design/coordinator.html" class="nav-link">English</a></li><li class="dropdown-item"><!----> <a href="/zh/docs/design/coordinator.html" class="nav-link router-link-exact-active router-link-active">简体中文</a></li></ul></div></div> <a href="https://github.com/lindb/lindb" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/zh/docs/quick-start.html" class="nav-link">文档</a></div><div class="nav-item"><a href="/zh/docs/community/contributor-guide.html" class="nav-link">社区</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Select language" class="dropdown-title"><span class="title">选择语言</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/docs/design/coordinator.html" class="nav-link">English</a></li><li class="dropdown-item"><!----> <a href="/zh/docs/design/coordinator.html" class="nav-link router-link-exact-active router-link-active">简体中文</a></li></ul></div></div> <a href="https://github.com/lindb/lindb" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>使用手册</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/zh/docs/quick-start.html" class="sidebar-link">快速上手</a></li><li><a href="/zh/docs/example.html" class="sidebar-link">示例</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>设计文档</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/zh/docs/design/architecture.html" class="sidebar-link">Architecture</a></li><li><a href="/zh/docs/design/coordinator.html" class="active sidebar-link">Coordinator</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/zh/docs/design/coordinator.html#overview" class="sidebar-link">Overview</a></li><li class="sidebar-sub-header"><a href="/zh/docs/design/coordinator.html#master" class="sidebar-link">Master</a></li><li class="sidebar-sub-header"><a href="/zh/docs/design/coordinator.html#task" class="sidebar-link">Task</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/zh/docs/design/coordinator.html#controller" class="sidebar-link">Controller</a></li><li class="sidebar-sub-header"><a href="/zh/docs/design/coordinator.html#executor" class="sidebar-link">Executor</a></li></ul></li><li class="sidebar-sub-header"><a href="/zh/docs/design/coordinator.html#state-machine" class="sidebar-link">State Machine</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/zh/docs/design/coordinator.html#broker-node-state-machine" class="sidebar-link">Broker Node State Machine</a></li><li class="sidebar-sub-header"><a href="/zh/docs/design/coordinator.html#storage-cluster-status-state-machine" class="sidebar-link">Storage Cluster Status State Machine</a></li><li class="sidebar-sub-header"><a href="/zh/docs/design/coordinator.html#db-admin-state-machine" class="sidebar-link">DB Admin State Machine</a></li><li class="sidebar-sub-header"><a href="/zh/docs/design/coordinator.html#storage-cluster-state-machine" class="sidebar-link">Storage Cluster State Machine</a></li><li class="sidebar-sub-header"><a href="/zh/docs/design/coordinator.html#replicator-state-machine" class="sidebar-link">Replicator State Machine</a></li><li class="sidebar-sub-header"><a href="/zh/docs/design/coordinator.html#replica-status-state-machine" class="sidebar-link">Replica Status State Machine</a></li></ul></li><li class="sidebar-sub-header"><a href="/zh/docs/design/coordinator.html#容错" class="sidebar-link">容错</a></li></ul></li><li><a href="/zh/docs/design/replication.html" class="sidebar-link">Replication</a></li><li><a href="/zh/docs/design/query.html" class="sidebar-link">Query</a></li><li><a href="/zh/docs/design/storage.html" class="sidebar-link">Storage</a></li><li><a href="/zh/docs/design/index_.html" class="sidebar-link">Index</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="coordinator"><a href="#coordinator" class="header-anchor">#</a> Coordinator</h1> <h2 id="overview"><a href="#overview" class="header-anchor">#</a> Overview</h2> <p>整个集群的协调操作都是由 Broker 来完成，那么为什么把这些重要的操作放在 Broker 上呢？</p> <ul><li>Broker 其实是充当计算节点，包括读写操作，因此 Broker 需要知道下层所有 Storage 节点的状态信息，因此直接把状态信息的协调任务放在Broker 中；</li> <li>Metadata 的变更不是很频繁，并且都是轻量操作；</li> <li>Storeage 节点的状态变更会比较频繁，但是 Broker 也需要这部分信息来选取 Shard 副本是可用的副本，所以没有必要让 Storage 来管理这些状态再同步给 Broker，这样的好处是 Storage 可以更专注在存储上；</li> <li>需要解决多机房之间相一数据库的计算能力，需要一些跨机房的操作的能力，把这部分的逻辑放在 Broker 上面也是比较适合的；</li></ul> <p>哪些信息需要处理？</p> <ul><li>数据库 DDL 操作；</li> <li>Storage 节点管理；</li> <li>运行时参数调整；</li> <li>Storage/Broker 状态管理；</li></ul> <p>所有协调及调度操作都是基于 ETCD 来完成，所有的调度消息都需要一个版本号，以跟踪各节点在 Metadata 变更后，各节点上的数据是否一致。</p> <h2 id="master"><a href="#master" class="header-anchor">#</a> Master</h2> <p>Master 负责主要的 Metadata 的变更，Master 从当前存活的 Broker 节点中选举出来，采用抢占式，即每个 Broker 节点同时去注册 Master KEY，谁先注册上成为 Master；</p> <p>同时每个 Broker 也会 Watch Master KEY，如果 Master KEY 上的信息丢失，重新进行选举，这样的好处是每个 Broker 都知道当前 Master 是哪个节点；</p> <p>Master KEY: /master/node，注册成功的 KEY: /master/node/{broker node}</p> <h2 id="task"><a href="#task" class="header-anchor">#</a> Task</h2> <p>这里说的 Task 主要是指 Broker/Master 下发给 Storage 需要执行的任务。主要包括如下 2 个角色：</p> <ul><li>Controller</li> <li>Executor</li></ul> <p>与 ETCD 有关系的 KEY 信息如下：</p> <ul><li>Task KEY: /task-coordinator/v1/executor/{storage node id}/kinds/{task kind}/names/{task name}</li> <li>Task Status KEY: /task-coordinator/v1/status/kinds/{task kind}/names/{task name}</li></ul> <h3 id="controller"><a href="#controller" class="header-anchor">#</a> Controller</h3> <p>Controller 运行在 Broker 层：</p> <ul><li>生成任务(Task KEY)：接受 Broker/Master 提交的任务，生成具体的 Task 并下发给 Storage 节点，下发操作通过 ETCD 来完成；</li> <li>对任务状态的跟踪(Task Status KEY)：在下发 Task 的同时会生成一个对 Task 状态的 Tracker，来跟踪具体 Task 的执行情况；</li></ul> <h3 id="executor"><a href="#executor" class="header-anchor">#</a> Executor</h3> <p>Executor 动行在 Storage 层：</p> <ul><li>执行任务：Executor 会 Watch 相应 Task KEY 上任务的变化来执行属于自己的 Task；</li> <li>任务状态的更新：会对相应 Task 执行结果的上报更新到 Task Status KEY；</li></ul> <h2 id="state-machine"><a href="#state-machine" class="header-anchor">#</a> State Machine</h2> <p>所有的这些操作由各种不同的状态机来完成，下面会对每个 State Machine 进行说明。</p> <p>不同的 State Machine 会 Watch 不同 ECTD 上面的 KEY 来完成相应的操作。</p> <h3 id="broker-node-state-machine"><a href="#broker-node-state-machine" class="header-anchor">#</a> Broker Node State Machine</h3> <p>该 State Machine 主要完成 Broker Node 的发现操作，运行于每个 Broker 节点。</p> <p>Watch KEY: /active/nodes</p> <ul><li>Broker 启动的时候都会把自己的信息注册到 Watch KEY 下面，即 /active/nodes/{borker node}；</li> <li>Watch KEY 的变化，每个 Broker 都知道当前 Broker 存活的节点有哪些；</li></ul> <h3 id="storage-cluster-status-state-machine"><a href="#storage-cluster-status-state-machine" class="header-anchor">#</a> Storage Cluster Status State Machine</h3> <p>该 State Machine 主要完成 Storage 集群各节点存活状态的跟踪，Broker 需要知道所有的 Storage 集群及其各节点的存活情况，运行于每个 Broker 节点。</p> <p>Watch KEY: /state/storage/cluster</p> <ul><li>Watch KEY 里面的信息由 Master 写入，Master 会 Watch 每个 Storage 集群各节点的存活情况，并把最终集群的信息写入到 Watch KEY 下面(/state/storage/cluster/{cluster name}), 具体请看  <a href="/zh/docs/design/coordinator.html#storage-cluster-state-machine">Storage Cluster State Machine</a> ；</li> <li>Broker Watch KEY 的变化，就可以知道每个 Storage 集群的状态信息；</li> <li>Broker 会根据 Storage 集群节点的情况，并结合当前 Broker WAL 的信息，生成 Broker -&gt; Storage 的复制通道，一但通道建立完成，就可以进行数据的复制操作，具体的复制请看 <a href="/zh/docs/design/replication.html">Replication</a> ；</li></ul> <h3 id="db-admin-state-machine"><a href="#db-admin-state-machine" class="header-anchor">#</a> DB Admin State Machine</h3> <p>该 State Machine 主要完成数据库相关的 DDL，运行于 Master。</p> <p>Watch Key: /database/config</p> <ul><li>用户可以提交数据库 DDL 到任意一台 Broker 节点，该 Broker 节点不生成具体的 Task 给 Storage，而是简单的把配置写在 &quot;/database/config/{db name}&quot; 下；</li> <li>Master Watch KEY 的变化，根据当前 Storage 集群的状态信息，生成 Shard Assignment；</li> <li>根据生成的 Shard Assignment 生成相应的 Task，下发给相应的 Storage 节点来执行相应的 DDL 操作；</li></ul> <p>Shard Assignment: 为某一数据库的每 Shard 的信息，主要包括如下信息：</p> <div class="language- extra-class"><pre class="language-text"><code>Name: 数据库名
Nodes:  该数据库各 Shard 的 Replica 所在的 Storage Nodes
Shards: 各 Shard 的信息

每个 Shard 包括如下信息：
ShardID: 该 Shard 对应的 ID
Replicas: 该 Shard 下所有 Replicas 的信息，对应上面 Nodes 里面的信息
</code></pre></div><h3 id="storage-cluster-state-machine"><a href="#storage-cluster-state-machine" class="header-anchor">#</a> Storage Cluster State Machine</h3> <p>该 State Machine 主要完成 Storage Cluster 配置信息的操作，运行于 Master。</p> <p>Watch KEY: /storage/cluster/config</p> <ul><li>用户可以提交 Storage Cluster 配置信息给任意一台 Broker 节点，该 Broker 节点只是简单的把配置信息写到 &quot;/storage/cluster/config/{cluster name}&quot; 下；</li> <li>Master Watch KEY 的变化，根据配置信息为每个 Storage 集群建立一个 Storage Cluster 的 Watch 机制，以发生每个 Storage 集群节点的存活情况；</li> <li>每个 Storage Cluster 的 Watch 会 Watch Storage 节点的存活情况，并把该 Storage 整体的状态信息写到 &quot;/state/storage/cluster/{cluster name}&quot; 下以供 <a href="/zh/docs/design/coordinator.html#storage-cluster-status-state-machine">Storage Cluster Status State Machine</a> 使用；</li></ul> <p>每个 Storage CLuster 的 Watch 机制如下：</p> <ul><li>根据 Storage 集群的配置信息，与 Storage 集群的 ETCD 建立关系；</li> <li>Watch Storage 集群节点存活的 KEY: /active/nodes (注意有别于与 Broker 的 /active/nodes，这里对应的是 Storage 相要注册的信息)；</li> <li>每个 Storage 节点启动的时候，需要注册节点信息到对应的 KEY 下面，即 /active/nodes/{storage node id}</li></ul> <h3 id="replicator-state-machine"><a href="#replicator-state-machine" class="header-anchor">#</a> Replicator State Machine</h3> <p>该 State Machine 主要完成每个数据库的 Shard WAL 的复制关系，运行于 Broker。</p> <p>Watch KEY：/database/assign</p> <ul><li>Watch KEY 的变化，根据 Shard Assignment 的信息，生成该数据库每个 Shard WAL 与目标 Storage 节点的关系，Shard Assignment 的写入，请看 <a href="/zh/docs/design/coordinator.html#db-admin-state-machine">DB Admin State Machine</a> ；</li> <li>注意这时只是建立关系不会建立真正的复制通道；</li></ul> <h3 id="replica-status-state-machine"><a href="#replica-status-state-machine" class="header-anchor">#</a> Replica Status State Machine</h3> <p>该 State Machine 主要监控每个 Replica 的复制状态，运行于 Broker。</p> <p>Watch KEY: /state/replica</p> <ul><li>WAL 复制会定期上报当前的复制状态，到对应的 KEY 下面 &quot;/state/replica/{storage node id}&quot; ；</li> <li>Broker Watch KEY 的变化，就可以知道每个复制通道复制的状态，在执行查询的时候可以选取最新副本的 Storage 节点进行查查；</li> <li>需要注意的点是复制状态信息，包括 Broker Node -&gt; Storage Node peer 下面所有的副本的状态，可能包括多个不同的数据库副本的复制状态；</li></ul> <h2 id="容错"><a href="#容错" class="header-anchor">#</a> 容错</h2> <ul><li>整个过程中 ETCD 成为了一个非常核心的组节，因为所有的协调及调度信息都是通过 ETCD 来完成。</li> <li>并且很多 Metadata 信息都存放在 ETCD 中；</li></ul> <p>因此如果 ETCD 出问题了对整个系统会产生很大的影响，那么怎么把影响做到最小是比较关键的：</p> <ol><li>首先 ETCD 挂了，极端情况 ETCD 中的数据损坏不能恢复了怎么办，因此需要在每次 Metadata 变更之后相关节点都需要做好本地的备份操作，并有能力通过这些备份数据能还原到新的 ETCD 集群中；</li> <li>ETCD 出问题不应该影响整个系统的可用性；</li> <li>只会影响期间 Metadata 变更的操作，一般 Metadata 变更是一个低频操作，因此这个是可被接受的；</li> <li>可能会影响副本数据不一致的情况，如这时 Leader 副本也有问题了；</li></ol></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/lindb/lindb.github.io/edit/dev/docs/zh/docs/design/coordinator.md" target="_blank" rel="noopener noreferrer">在 GitHub 上编辑此页</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <div class="last-updated"><span class="prefix">最后更新:</span> <span class="time">10/20/2019, 3:23:11 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/zh/docs/design/architecture.html" class="prev">Architecture</a></span> <span class="next"><a href="/zh/docs/design/replication.html">Replication</a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.57b9579b.js" defer></script><script src="/assets/js/2.e103f43c.js" defer></script><script src="/assets/js/25.f96214da.js" defer></script>
  </body>
</html>
